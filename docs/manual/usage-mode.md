# 使用模式

!!! warning "资源多≠速度快"
    无论使用以下哪种方式申请计算资源，并不意味着申请的资源越多，计算速度就会越快。程序必须经过并行计算优化，才能取得更快的计算速度，比如，CPU程序要经过多核优化，GPU程序要利用CUDA加速。

## 1. 模式对比

我们提供了以下几类使用方式：

![整体对比](../images/overview.svg)

|        | 共享集群                           | 交互实例                                                                         | Linux虚拟机                                                                     | Windows虚拟机                                                                   |
| ------ | ------------------------------ | ---------------------------------------------------------------------------- | ---------------------------------------------------------------------------- | ---------------------------------------------------------------------------- |
| 适用人群   | 对Linux命令行熟悉，计算量大。              | 不熟悉Linux，计算量相对较小，使用图形界面快速实验验证一些想法。**无计算机背景的新用户建议使用这种模式。**                    | 需要在Linux系统上进行系统开发，适合计算机相关专业                                                  | 只习惯Windows系统，不习惯Linux系统                                                      |
| 速度     | 快                              | 中                                                                            | 慢                                                                            | 慢                                                                            |
| 应用类型   | 绝大多数计算任务：深度学习等                 | JupyterLab、RStudio等有交互界面；MATLAB、Stata的Linux版本。“申请资源”页面的 Jupyterlab、RStudio、vscode、远程桌面等。                                  | 需要徒手搭建的软件或系统。“申请资源”页面的 Ubuntu_虚拟机等带有“虚拟机”字样。                                                                   | Windows上的SAS、Stata等所有软件。“申请资源”页面带有Windows字样。                                                     |
| 计算资源   | 高端计算资源：高端CPU、高端GPU             | 普通CPU、普通GPU                                                                  | 普通CPU、普通GPU                                                                  | 普通CPU                                                                        |
| 申请资源   | 编写资源申请脚本，使用作业调度软件提交作业          | 在Web界面申请资源                                                                   | 在Web界面申请资源                                                                   | 在Web界面申请资源，使用远程登录软件登录到对应虚拟机。                                                 |
| 计费方式   | 从作业启动后开始计费，直到作业结束，作业结束后资源自动释放。 | 从申请到计算资源开始计费，直到资源释放为止。有最长使用期限，超过最长使用期限后系统自动释放资源，用户也可以自己手动释放资源。最长使用期限可与管理员协商。 | 从申请到计算资源开始计费，直到资源释放为止。有最长使用期限，超过最长使用期限后系统自动释放资源，用户也可以自己手动释放资源。最长使用期限可与管理员协商。 | 从申请到计算资源开始计费，直到资源释放为止。有最长使用期限，超过最长使用期限后系统自动释放资源，用户也可以自己手动释放资源。最长使用期限可与管理员协商。 |
| 资源占用   | 全校共享一个计算集群，多用户排队提交作业           | 个人独占单节点计算资源                                                                  | 个人独占单节点计算资源                                                                  | 个人独占单节点计算资源                                                                  |
| 图形界面   | 不支持                            | 支持                                                                           | 不支持                                                                          | 支持                                                                           |
| root权限 | 否                              | 是                                                                            | 是                                                                            | 是                                                                            |

如上表所示，计算平台主要支持四种模式：

1. 对于计算资源使用量较大、有一定Linux命令行基础的用户，可以考虑使用**共享集群**模式。共享集群模式使用作业调度系统提交作业。共享集群中的计算资源丰富且强大。
2. 如果对Linux命令行不熟悉，我们提供了**交互实例**模式，可以在“申请资源”处申请有交互界面的计算资源，我们提供了Jupyter、RStudio等有交互界面的工具、MATLAB、Stata等远程登录，上手相对简单，适用于无计算机背景的新用户。此模式优点是学习成本低，缺点是计费方式粒度粗，不适合有大量计算任务的用户。用户也可以前期使用这类交互界面实例，如发现计算量较大，建议逐渐迁移到**共享集群**模式上，该模式计费更准确。
3. 如果您想进行Linux系统开发，徒手搭建系统，可以使用**Linux虚拟机**模式，比如Ubuntu。需要注意的是，Ubuntu虚拟机有性能损失，不适合进行大量高性能计算。
4. 如果您无法适应Linux操作，必须使用Windows，我们提供了Windows虚拟机，并提供Windows SAS、Stata等软件。需要注意的是，Windows虚拟机有性能损失，速度慢。

综上，无计算机背景的新用户建议使用**交互实例**模式。下面将分别简述四种模式的使用方法。

## 2. 共享集群

共享集群以传统的作业调度方式提供公共共享的计算资源，所有用户无需申请资源即可直接登陆使用。用户在共享集群内使用资源时要以提交作业的方式申请计算资源，通过 SLURM 作业调度系统将计算任务分发到计算节点上。

![共享集群入口](../images/public_cluster_entry.png)

在计算平台上，点击“共享资源”，选择“public_cluster”进入该集群。该集群内配置了x86服务器、GPU服务器等多种计算资源，不同的计算资源分布在不同的队列中。用户在共享集群里只具有普通用户权限，可通过 SSH 客户端直接登陆集群，也可以用Web界面的 SSH 工具登录集群。

用户可以进入[共享集群使用方法](../slurm/GPU-Cluster.md)页面查看具体使用方法。

## 3. 交互实例

交互实例适合不熟悉Linux，习惯交互式图形界面的用户。交互实例可支持Jupyter、RStudio、MATLAB、Stata等。

### 3.1 创建实例

1.申请资源

首次使用，用户需要点击“申请资源”，在其中申请计算资源。之后，用户需要在过滤条件处选出自己所需的计算资源，比如Jupyter、RStudio等；接着要选择该镜像所需资源，比如16核、1GPU卡、46GB内存等。点击创建“创建实例”。

![申请交互实例](../images/apply_resource.png)

2.填写必要信息

名称: 为该实例名称，用于分辨同一用户创建的不同实例。

通知邮箱: 用于发送平台通知，例如使用最长到时间即将到期时，将发送邮件通知用户。

计费账户：学生用户可选择自己所属于的课题组，所产生的机时费用将计算到该课题组。

节点资源设置: 用于设置实例的节点资源，可选的资源也不同，根据自身需要设置。`BindCPU`是指让一个任务跑在指定的cpu上，默认设置为`True`可防止缓存切换，提升性能。

!!! warning "使用和计费"
    该模式从创建开始计费，直到自动或手动释放资源停止计费。为避免申请到资源不进行计算或者正在进行计算时超时系统自动回收资源，用户一定要注意“使用周期”和“通知邮箱”项，并定期查看邮箱中来自<cc-admin@ruc.edu.cn>的邮件。

3.启动实例

在“我的资源”中启动该实例。“操作”栏分别有启动、关停、Jupyter Web界面链接等信息。用户需要点击启动按钮，启动该实例。“状态”栏中，绿色表示已启动，灰色表示已关停。

![在我的资源中启动该实例](../images/my_resource.png)

4.启动后，用户可以点击“操作”栏的控制台或用户界面按钮。

![进入控制台或用户界面](../images/ops_instance.png)

5.在控制台的命令行中敲击命令`sudo -i`切换到超级用户，可以安装一些软件或开发包。

!!! note "排队等待"
    本模式下，如果同时使用的用户太多，已有计算资源全部分配出去，新申请的实例会排队等待，出现“分配中”的状态，后面的数字为在队列中的位置。排队到资源后，系统会邮件通知用户。

### 3.2 释放资源

用户可以对申请的实例执行释放操作以释放资源。

1.点击图中的停止按钮，对实例进行关停操作。

![关停实例](../images/stop_instance.png)

2.点击释放资源按钮释放所分配的资源。释放后，该实例进入回收站，可在“资源回收”中找到。

![释放资源](../images/release_instance.png)

!!! warning "如不进行计算，建议及时释放资源！"
    只有手动点击释放资源按钮才会停止计费。如不释放资源，计算资源将一直占用，直至最长使用期限。

3.下次使用时，可不必重新申请资源，只需在“资源回收”中点击“恢复分配”按钮。

![在“资源回收”中恢复该镜像](../images/trash_bin.png)

!!! note "软件和数据"
    用户可以在实例中安装自己所需的软件或开发包、上传自己的数据，比如使用`conda`安装Python包。释放资源后，这些软件依然保存在镜像中，下次使用，可以在“资源回收”页面恢复，该实例将恢复至“我的资源”页面，这些软件和数据不会被清理删除，用户可继续使用它们。

## 4. Linxu & Windows虚拟机

**虚拟机**模式申请资源的方式与**交互实例**基本一致。但虚拟机模式的性能损失大：1，用户无法使用InfiniBand的高速网络，计算节点之间、计算节点与存储之间的网络延迟高；2，虚拟化的性能损失大。

### 4.1 Windows虚拟机

Windows虚拟机，以及在虚拟机中预安装软件（例如Stata、SAS），在申请资源时，均带有“windows”字样的虚拟机，请在[Windows使用页面](../virtual/windows.md)查看具体申请、登录、上传数据等使用方法。

### 4.2 Linux虚拟机

申请到虚拟机实例后，需要给这台虚拟机初始化root账户密码，如下图所示，之后再以root身份登录该虚拟机。

![虚拟机](../images/virtual_machine.png)